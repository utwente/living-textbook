stages:
  - prepare
  - lint
  - build
  - tests
  - sentry
  - deploy

include:
  # Prepare
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/symfony/install-dependencies.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/yarn/install-js-dependencies.yml'

  # Lint
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/php/cve-check.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/php/composer-require-checker.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/php/composer-unused.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/shell/shellcheck.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/php/phan.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/ts/tslint.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/yaml/yamllint.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/yarn/audit.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/sass/sasslint.yml'

  # Build
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/yarn/build-prod.yml'

  # Tests
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/php/phpunit.yml'
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/symfony/check-security.yml'

  # Sentry
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/sentry/sentry.yml'

  # Deploy
  - project: 'intern/runner-templates'
    ref: "3.11"
    file: '/deploy/deploy.yml'

install-dependencies:
  artifacts:
    paths:
      # Default paths from this stage. If you need more, make sure to copy these in your build step
      - assets/js/_fos_routes.json
      - vendor/friendsofsymfony/jsrouting-bundle/Resources/public/js
      - vendor/drenso/symfony-shared/src/Resources/translations
      - .secrets.json
      # Extra paths
      - assets/js/_fos_js_routes.js
      - vendor/studio-42/elfinder/css
      - vendor/studio-42/elfinder/img
      - vendor/studio-42/elfinder/js
      - vendor/studio-42/elfinder/sounds
  before_script:
    - cp .secrets.json.dist .secrets.json
    - if [ "$CI_COMMIT_REF_NAME" = "gima2021" ]; then export HTTP_HOST="${GIMA2021_HOST}:${STAGING_HOST_PORT}"; fi # Fix for http-host used in fos-js routing
    - if [ -z ${COMPOSER_USER+x} ]; then echo "COMPOSER_USER not set, skipping composer auth configuration" ; else composer config http-basic.composer.drenso.dev ${COMPOSER_USER} ${COMPOSER_PASSWORD}; fi

js-analysis:
  stage: lint
  image:
    name: eeacms/jshint:latest
    entrypoint: [ "" ]
  needs: [ ]
  before_script:
    - cp tests/jshint/.jshintignore .
  script:
    - /usr/bin/jshint src --verbose --config tests/jshint/config
  tags:
    - docker
  except:
    - master
    - production

action-security-check:
  script:
    - php bin/console ltb:check:action-security

deploy-gima2021:
  stage: deploy
  image: kickin/ssh:1.2.0
  resource_group: deploy-staging
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - mkdir -p ~/.ssh
    - echo "${STAGING_HOST_SSH} ${STAGING_HOST_SSH_FINGERPRINT}" >> ~/.ssh/known_hosts
    - echo "[${STAGING_HOST_SSH}]:${STAGING_HOST_SSH_PORT} ${STAGING_HOST_SSH_FINGERPRINT}" >> ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "${GIMA2021_HOST_SSH_PRIVATE_KEY}")
  script:
    - ssh -tt ${STAGING_USER}@${STAGING_HOST_SSH} -p ${STAGING_HOST_SSH_PORT} ${CI_PIPELINE_ID}
  environment:
    name: GIMA-2021
    url: https://living-textbook-gima2021.drenso.dev
  tags:
    - docker-deploy
  only:
    - gima2021
  except:
    - schedules

deploy-production:
  before_script:
    - mkdir -p ~/.ssh
    - echo "${JUMP_HOST} ${JUMP_HOST_SSH_FINGERPRINT}" >> ~/.ssh/known_hosts
    - echo "${PRODUCTION_HOST_SSH} ${PRODUCTION_HOST_SSH_FINGERPRINT}" >> ~/.ssh/known_hosts
    - echo "[${PRODUCTION_HOST_SSH}]:${PRODUCTION_HOST_SSH_PORT} ${PRODUCTION_HOST_SSH_FINGERPRINT}" >> ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "${PRODUCTION_HOST_SSH_PRIVATE_KEY}")
    - ssh-add <(echo "${JUMP_HOST_SSH_PRIVATE_KEY}")
  script:
    - ssh -tt -J ${JUMP_USER}@${JUMP_HOST} ${PRODUCTION_USER}@${PRODUCTION_HOST_SSH} -p ${PRODUCTION_HOST_SSH_PORT} ${CI_PIPELINE_ID}
